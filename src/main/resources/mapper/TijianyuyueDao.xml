<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dao.TijianyuyueDao">

    <!-- 实体映射 -->
    <resultMap type="com.entity.TijianyuyueEntity" id="tijianyuyueMap">
        <id property="id" column="id"/>
        <result property="addtime" column="addtime"/>
        <result property="tijianxiangmu" column="tijianxiangmu"/>
        <result property="taocantupian" column="taocantupian"/>
        <result property="tijianneirong" column="tijianneirong"/>
        <result property="tijiandanwei" column="tijiandanwei"/>
        <result property="taocanjiage" column="taocanjiage"/>
        <result property="keyuerenshu" column="keyuerenshu"/>
        <result property="zongjine" column="zongjine"/>
        <result property="tijiandidian" column="tijiandidian"/>
        <result property="yonghuzhanghao" column="yonghuzhanghao"/>
        <result property="yonghuxingming" column="yonghuxingming"/>
        <result property="shoujihaoma" column="shoujihaoma"/>
        <result property="yuyueshijian" column="yuyueshijian"/>
        <result property="zhanghao" column="zhanghao"/>
        <result property="xingming" column="xingming"/>
        <result property="sfsh" column="sfsh"/>
        <result property="shhf" column="shhf"/>
        <result property="ispay" column="ispay"/>
        <result property="timeslot" column="timeslot"/>
        <result property="remindFlag" column="remindFlag"/>
        <result property="cancelTime" column="cancelTime"/>
        <result property="updateTime" column="updateTime"/>
    </resultMap>


    <!-- 基础查询 -->
    <select id="selectListVO" resultType="com.entity.vo.TijianyuyueVO">
        SELECT * FROM tijianyuyue
        <where> 1=1 ${ew.sqlSegment}</where>
    </select>

    <select id="selectVO" resultType="com.entity.vo.TijianyuyueVO">
        SELECT tijianyuyue.* FROM tijianyuyue tijianyuyue
        <where> 1=1 ${ew.sqlSegment}</where>
    </select>

    <select id="selectListView" resultType="com.entity.view.TijianyuyueView">
        SELECT tijianyuyue.* FROM tijianyuyue tijianyuyue
        <where> 1=1 ${ew.sqlSegment}</where>
    </select>

    <select id="selectView" resultType="com.entity.view.TijianyuyueView">
        SELECT * FROM tijianyuyue tijianyuyue
        <where> 1=1 ${ew.sqlSegment}</where>
    </select>

    <!-- ✅ 新增方法 -->

    <!-- 1. 检查预约时间冲突 -->
    <select id="checkTimeConflict" resultType="int">
        SELECT COUNT(*) FROM tijianyuyue
        WHERE yonghuzhanghao = #{userId}
          AND DATE_FORMAT(yuyueshijian, '%Y-%m-%d') = #{appointmentDate}
          AND timeslot = #{timeslot}
          AND sfsh = '已审核'
    </select>

    <!-- 2. 查询需要提醒的预约记录（3天内到期且未提醒） -->
    <select id="selectRemindList" resultMap="tijianyuyueMap">
        SELECT * FROM tijianyuyue
        WHERE DATEDIFF(yuyueshijian, NOW()) &lt;= 3
          AND remindFlag = 0
          AND sfsh = '已审核'
    </select>


    <!-- 3. 批量更新提醒标记 -->
    <update id="batchUpdateRemindFlag">
        UPDATE tijianyuyue
        SET remindFlag = 1
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>  <!-- 这个必须有 -->
    </update>


</mapper>
